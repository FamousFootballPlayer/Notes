# 2. Security of Threads

Today, let's talk about the lock and the thread. As we all known, if we want to let our code using muti-threads more safety, it is important that we need to manage the operation of accsessing the state.Especially, we need to be more cautious about accessing the shared state and the mutable state.

The sharing means that the state can be accessed by lots of threads. And the mutable means that the state can be changed as long as it exists. 

一个对象是否是线程安全的取决于很多因素，个人总结如下：

1. 这个对象是否是线程封闭的（即每个线程都有一份副本，当线程访问时，访问的其实是其拥有的副本）
2. 该对象是否拥有状态，如果该对象是没有状态的，则无论多少线程访问，其实他都是线程安全的。
3. 该对象的状态是否是不变的，如果该对象的状态是不变的，那么多个线程访问，也只能从中取出数据，无法更改，并无意义，所以该对象是线程安全的。
4. 该对象是否会被多个线程访问，如果不满足上述三种条件，而且该对象可以被多个线程访问，并且访问操作没有进行合理同步，那么该对象就不是线程安全的。

如果当多个线程访问同一个可变的状态变量时，没有使用合适的同步，那么程序就会出现错误，有三种形式可以修复该错误：

1. 不在线程之间共享该状态的变量
2. 该状态变量设置为不可变的变量
3. 在访问状态变量时使用同步

如果在设计类的时候没有考虑并发的情况，就要根据上述的情况进行修改，然而这种方法导致的修复难度极大，因此如果一开始就设计一个线程安全的类比之后再修改更简单。面向对象的技术不仅有助于编写的代码结构优雅、可维护性高，还有助于编写出线程安全的类，因为访问的入口可以被良好的控制。

编写并发应用程序时，一种正确的变成方式是：首先使代码正确运行，然后再提升代码速度。只有在性能测试结果和应用需求告诉你必须提高性能时，才进行优化。允许因为并发问题而不满足封装与抽象。

## 什么是线程安全性

对于线程安全性，首先需要定义正确性，正确性的含义是：某个类的行为与其规范完全一致。在良好的规范中会定义各种不变性条件来约束对象的状态，以及各种后验条件来描述对象的操作结果。

当多个线程访问某个类时，不管运行时环境采用何种调度方式或者这些线程将如何交替执行，并且在主调代码中不需要任何额外的同步或协同，这个类都能表现出正确的行为，那么就称这个类是线程安全的。


